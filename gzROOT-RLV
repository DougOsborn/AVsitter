//start_unprocessed_text
/*/*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Copyright © the AVsitter Contributors (http://avsitter.github.io)
 * AVsitter™ is a trademark. For trademark use policy see:
 * https://avsitter.github.io/TRADEMARK.mediawiki
 *
 * Please consider supporting continued development of AVsitter and
 * receive automatic updates and other benefits! All details and user
 * instructions can be found at http://avsitter.github.io
 *|/

string product = "AVsitter™ RLV";
string version = "2.2";
integer ignorenextswap;
string notecard_name = "AVpos";
string unDressScript = "[AV]root-RLV-extra";
integer RLV_ON = TRUE;
string WAITPOSE;
string DOMPOSE;
string SUBPOSE;
integer HTEXT = 1;
list SITTER_DESIGNATIONS_MASTER = ["S"];
list DESIGNATIONS_NOW;
string onTouch = "ASK";
string onSit = "CAPTURE";
integer autoRecapture;
key notecard_key;
key notecard_query;
integer notecard_line;
integer RELAY_CHANNEL = -1812221819;
integer RELAY_SEARCH_CHANNEL;
integer RELAY_GETCAPTURESTATUSchannel;
integer RELAY_CHECK_CHANNEL;
integer ASKROLE_CHANEL = -748363;
integer menu_channel;
integer menu_handle;
integer relay_handle;
integer GETCAPTURESTATUShandle;
integer SEARCHhandle;
integer CHECKhandle;
integer ASKROLEhandle;
list DETECTED_AVATAR_SHORTNAMES;
list DETECTED_AVATAR_KEYS;
integer awaiting_results;
string baseCaptureRestrictions = "@unsit=n";
string baseReleaseRestrictions = "@unsit=force";
integer expected_number;
integer expecting_relay_results;
integer controllerHasKeys;
string PairWhoStartedCapture = "NA";
integer defaultTimelock;
integer TimelockSecUntilRelease;
integer TimelockHidden;
integer TimelockPaused;
key CONTROLLER = "";
string controllerName;
key SLAVE;
string slaveName;
integer slaveWearingRelay;
list CAPTIVES;
list SITTERS;
list SITTING_AVATARS;
list SITTERS_MENUKEYS;
list SITTERS_SHORTNAMES;
integer activePrim;
string menu;
integer menuPage;
integer subControl;
string ping;
integer captureOnAsk = TRUE;
integer verbose = 0;

Out(integer level, string out)
{
    if (verbose >= level)
    {
        llOwnerSay(llGetScriptName() + "[" + version + "]:" + out);
    }
}

string strReplace(string str, string search, string replace)
{
    return llDumpList2String(llParseStringKeepNulls(str, [search], []), replace);
}

list order_buttons(list buttons)
{
    return llList2List(buttons, -3, -1) + llList2List(buttons, -6, -4) + llList2List(buttons, -9, -7) + llList2List(buttons, -12, -10);
}

relay(key av, string msg)
{
    msg = "RLV," + (string)av + "," + msg;
    llSay(RELAY_CHANNEL, msg);
}

string humantime()
{
    integer hours = TimelockSecUntilRelease / 3600;
    integer minutes = TimelockSecUntilRelease % 3600;
    integer seconds = minutes % 60;
    minutes = minutes / 60;
    string hours_text;
    string minutes_text;
    string seconds_text;
    if (hours)
    {
        hours_text = (string)hours + " hrs, ";
    }
    if (minutes || hours)
    {
        minutes_text = (string)minutes + " min";
    }
    if (!hours)
    {
        if (minutes)
        {
            seconds_text += ", ";
        }
        seconds_text += (string)seconds + " sec";
    }
    return hours_text + minutes_text + seconds_text;
}

Timelock_menu()
{
    menu = "Timelock";
    list menu_items = ["+1min", "+30min", "+1hrs"];
    string text = "Time Remaining: " + humantime() + "\n";
    string pauseButton = " ";
    string hidButton = " ";
    if (TimelockSecUntilRelease)
    {
        pauseButton = "Stop";
        if (TimelockPaused)
        {
            pauseButton = "Start";
            text += "\nTimelock Stopped";
            if (TimelockSecUntilRelease)
            {
                menu_items += ["-1min", "-30min", "-1hrs"];
            }
        }
        if (!TimelockPaused)
        {
            hidButton = "Hide";
            if (TimelockHidden)
            {
                hidButton = "Show";
                text += "\nTimelock Hidden";
            }
        }
    }
    dialog(text, ["[BACK]", pauseButton, hidButton] + menu_items);
}

relay_select_menu()
{
    menu = "SELECT";
    list menu_items;
    integer i;
    for (i = 0; i < llGetListLength(DETECTED_AVATAR_KEYS); i++)
    {
        if (llListFindList(SITTING_AVATARS, [llList2Key(DETECTED_AVATAR_KEYS, i)]) == -1)
        {
            menu_items += llList2String(DETECTED_AVATAR_SHORTNAMES, i);
        }
    }
    string text = "No RLV relays found in range!";
    if (llGetListLength(menu_items))
    {
        text = "Who do you want to capture?\n\nRLV relays found on:\n";
    }
    if (CONTROLLER == llGetOwner() && (!llGetListLength(SITTING_AVATARS)))
    {
        menu_items += "[SECURITY]";
    }
    dialog(text, menu_items);
}

playpose(string pose, string target_sitter)
{
    if (pose != "")
    {
        llSleep(1);
        llMessageLinked(LINK_SET, 90000, pose, target_sitter);
    }
}

rlv_top_menu()
{
    menu = "";
    list menu_items;
    string text = "RLV for " + slaveName;
    list extra;
    if (llGetListLength(SITTING_AVATARS) > 1 || ~llListFindList(DESIGNATIONS_NOW, ["S"]))
    {
        extra += "[BACK]";
    }
    integer designationIndex = llListFindList(DESIGNATIONS_NOW, [SLAVE]);
    if (RLV_ON)
    {
        if (llListFindList(CAPTIVES, [SLAVE]) == -1)
        {
            if (slaveWearingRelay)
            {
                if (~designationIndex && llList2String(SITTER_DESIGNATIONS_MASTER, designationIndex) == "D")
                {
                    text = slaveName + " has not chosen female role.";
                }
                else
                {
                    menu_items += ["Capture!"];
                }
            }
            else
            {
                text = "No RLV relay found for " + slaveName + ".";
            }
        }
        else
        {
            menu_items += ["Timelock"];
            if (llGetInventoryType(unDressScript) == INVENTORY_SCRIPT)
            {
                menu_items += ["Restrict", "Un/Dress"];
            }
            menu_items += ["Release!"];
            if (controllerHasKeys)
                extra += ["Drop Keys"];
            else
                extra += ["Take Keys"];
        }
        if (llList2String(SITTER_DESIGNATIONS_MASTER, designationIndex) == "S")
        {
            if (llListFindList(SITTING_AVATARS, [CONTROLLER]) == -1)
            {
                menu_items += ["[STOP]"];
            }
            menu_items += ["Menu..."];
        }
    }
    else
    {
        text = "RLV is off.";
    }
    dialog(text, extra + menu_items);
}

capture_attempt(key id, string target_sitter)
{
    if (RLV_ON)
    {
        relay(id, baseCaptureRestrictions);
        llListenRemove(GETCAPTURESTATUShandle);
        GETCAPTURESTATUShandle = llListen(RELAY_GETCAPTURESTATUSchannel, "", "", "");
        relay(id, "@getstatus=" + (string)RELAY_GETCAPTURESTATUSchannel);
    }
    if (llGetInventoryType("[AV]sitA 1") == INVENTORY_SCRIPT)
    {
        playpose(SUBPOSE, target_sitter);
    }
    else
    {
        playpose(SUBPOSE, id);
    }
}

dialog(string text, list buttons)
{
    llDialog(CONTROLLER, product + " " + version + "\n\n" + text, order_buttons(buttons), menu_channel);
}

reset()
{
    CAPTIVES = [];
    CONTROLLER = "";
    controllerHasKeys = FALSE;
    TimelockHidden = FALSE;
    TimelockPaused = FALSE;
    llSetTimerEvent(0);
    TimelockSecUntilRelease = defaultTimelock;
    hovertext();
}

unsit_all()
{
    integer i = llGetNumberOfPrims();
    while (llGetAgentSize(llGetLinkKey(i)) != ZERO_VECTOR)
    {
        llUnSit(llGetLinkKey(i));
        i--;
    }
}

release_all()
{
    while (llGetListLength(CAPTIVES))
    {
        release(llList2Key(CAPTIVES, 1), FALSE);
    }
}

stop()
{
    release_all();
    unsit_all();
    reset();
}

release(key SLAVE, integer allowUnsit)
{
    integer index = llListFindList(CAPTIVES, [SLAVE]);
    if (~index)
    {
        CAPTIVES = llDeleteSubList(CAPTIVES, index - 1, index);
        llSay(0, llKey2Name(SLAVE) + " was released.");
        relay(SLAVE, baseReleaseRestrictions);
        relay(SLAVE, "!release");
        if (allowUnsit && ~llSubStringIndex(baseReleaseRestrictions, "@unsit=force"))
        {
            llUnSit(SLAVE);
        }
    }
    if (!llGetListLength(CAPTIVES))
    {
        reset();
    }
}

start_relay_search()
{
    DETECTED_AVATAR_KEYS = [];
    DETECTED_AVATAR_SHORTNAMES = [];
    slaveWearingRelay = 0;
    llSensor("", NULL_KEY, AGENT, 20, PI);
    expecting_relay_results = TRUE;
    SEARCHhandle = llListen(RELAY_SEARCH_CHANNEL, "", "", "");
    llSetTimerEvent(1.5);
}

remove_script(string reason)
{
    string message = "\n" + llGetScriptName() + " ==Script Removed==\n\n" + reason;
    llDialog(llGetOwner(), message, ["OK"], -3675);
    llInstantMessage(llGetOwner(), message);
    if (llGetOwner() != "b30c9262-9abf-4cd1-9476-adcf5723c029" && llGetOwner() != "f2e0ed5e-6592-4199-901d-a659c324ca94")
    {
        llRemoveInventory(llGetScriptName());
    }
}

new_controller(key id)
{
    CONTROLLER = id;
    controllerName = llKey2Name(CONTROLLER);
    llListenRemove(menu_handle);
    menu_handle = llListen(menu_channel = ((integer)llFrand(0x7FFFFF80) + 1) * -1, "", CONTROLLER, ""); // 7FFFFF80 = max float < 2^31
}

no_sensor_results()
{
    expecting_relay_results = FALSE;
    list menu_items;
    if (CONTROLLER == llGetOwner())
    {
        menu_items += "[SECURITY]";
    }
    dialog("No avatars found in range!", menu_items);
}

get_unique_channels()
{
    RELAY_SEARCH_CHANNEL = (integer)llFrand(999999936) + 1; // 999999936 = max float < 1e9
    RELAY_GETCAPTURESTATUSchannel = RELAY_SEARCH_CHANNEL + 2;
    RELAY_CHECK_CHANNEL = RELAY_SEARCH_CHANNEL + 4;
    ASKROLE_CHANEL = ((integer)llFrand(0x7FFFFF80) + 1) * -1; // 7FFFFF80 = max float < 2^31
    llListenRemove(relay_handle);
    relay_handle = llListen(RELAY_CHANNEL, "", "", ping = "ping," + (string)llGetKey() + ",ping,ping");
}

check_female()
{
    relay(SLAVE, "@versionnew=" + (string)RELAY_CHECK_CHANNEL);
    slaveWearingRelay = -1;
    llSensorRepeat("", llGetOwner(), PASSIVE, 0.1, PI, 2);
    slaveName = llKey2Name(SLAVE);
}

select_female_rlv()
{
    menu = "SUB_SELECT";
    string text = "Which female?";
    SITTERS_MENUKEYS = [];
    list menu_items;
    integer i;
    for (i = 0; i < llGetListLength(SITTER_DESIGNATIONS_MASTER); i++)
    {
        if (llList2String(SITTER_DESIGNATIONS_MASTER, i) == "S")
        {
            if (llList2Key(DESIGNATIONS_NOW, i)) // OSS::key k = llList2Key(DESIGNATIONS_NOW, i); if (osIsUUID(k) && k != NULL_KEY)
            {
                menu_items += llGetSubString(strReplace(llKey2Name(llList2Key(DESIGNATIONS_NOW, i)), " Resident", ""), 0, 11);
                SITTERS_MENUKEYS += llList2Key(DESIGNATIONS_NOW, i);
            }
        }
    }
    SITTERS_SHORTNAMES = menu_items;
    if (!llGetListLength(menu_items))
    {
        text = "There are no females sitting.";
    }
    if (~llListFindList(DESIGNATIONS_NOW, ["S"]) && llGetListLength(SITTING_AVATARS) < llGetListLength(DESIGNATIONS_NOW))
    {
        text += "\n\nCapture = trap a new avatar.";
        menu_items += "Capture...";
    }
    else if (llGetListLength(menu_items) == 1)
    {
        SLAVE = llList2Key(SITTERS_MENUKEYS, 0);
        check_female();
        return;
    }
    dialog(text, menu_items);
}

find_seat(key id, integer index, string msg, integer captureSub)
{
    if (~index)
    {
        integer first_available = index;
        if (~llListFindList(DESIGNATIONS_NOW, [id]))
        {
            first_available = llListFindList(DESIGNATIONS_NOW, [id]);
        }
        else if (llList2String(DESIGNATIONS_NOW, index) != llGetSubString(msg, 0, 0))
        {
            first_available = llListFindList(DESIGNATIONS_NOW, [llGetSubString(msg, 0, 0)]);
        }
        if (~first_available)
        {
            if (msg == "Male")
            {
                playpose(DOMPOSE, (string)first_available);
            }
            else if (msg == "Female")
            {
                if (captureSub)
                {
                    capture_attempt(id, (string)first_available);
                }
            }
            if (first_available != index)
            {
                if (llGetInventoryType("[AV]sitA 1") == INVENTORY_SCRIPT)
                {
                    llSleep(1);
                    llMessageLinked(LINK_SET, 90030, (string)index, (string)first_available);
                    ignorenextswap = TRUE;
                }
            }
            DESIGNATIONS_NOW = llListReplaceList(DESIGNATIONS_NOW, [id], first_available, first_available);
            if (llListFindList(DESIGNATIONS_NOW, ["S"]) == -1)
            {
                integer i = llGetListLength(CAPTIVES) - 1;
                while (i > 0)
                {
                    if (llListFindList(SITTING_AVATARS, [llList2Key(CAPTIVES, i)]) == -1)
                    {
                        CAPTIVES = llDeleteSubList(CAPTIVES, i - 1, i);
                    }
                    i -= 2;
                }
            }
            hovertext();
            llMessageLinked(LINK_THIS, 90206, llDumpList2String(DESIGNATIONS_NOW, "|"), "");
            if (msg == "Male")
            {
                llSleep(1);
                llMessageLinked(LINK_THIS, 90007, "", id);
            }
        }
        else
        {
            llUnSit(id);
            info_dialog(id, "there no available seats for " + msg);
        }
    }
}

info_dialog(key id, string text)
{
    llDialog(id, product + " " + version + "\n\nSorry, " + text + ".\n", ["OK"], -7947386);
}

hovertext()
{
    string text;
    vector color = <0,1,0>;
    if (llGetListLength(CAPTIVES))
    {
        string s;
        if (llGetListLength(CAPTIVES) > 2)
        {
            s = "s";
        }
        text += "\n \nCaptive" + s + ":\n";
        integer i;
        for (i = 0; i < llGetListLength(CAPTIVES); i += 2)
        {
            string captiveName = llList2String(CAPTIVES, i);
            key captiveUUID = (key)llList2String(CAPTIVES, i + 1);
            text += "\"" + captiveName + "\"\n";
        }
        if (TimelockSecUntilRelease)
        {
            if (TimelockPaused)
            {
            }
            else if (llGetListLength(SITTING_AVATARS) && llGetListLength(CAPTIVES))
            {
                text += "\n \nTimelocked for:\n";
                if (TimelockHidden)
                {
                    text += "(hidden)";
                }
                else
                {
                    text += humantime();
                }
            }
        }
        if (!controllerHasKeys)
        {
            text += "\n \nKeys available";
        }
        if (controllerHasKeys)
        {
            color = <1,0,0>;
            text += "\n \nLocked by:\n\"" + controllerName + "\"";
        }
    }
    if (HTEXT)
    {
        integer i = 1;
        while (i++ < HTEXT)
        {
            text += "\n ";
        }
        llSetText(text, color, 0.8);
    }
    else
    {
        llMessageLinked(LINK_SET, 90207, text, (string)color);
    }
    llMessageLinked(LINK_SET, 90014, llDumpList2String([CONTROLLER, llDumpList2String(CAPTIVES, ",")], "|"), "");
}

ask_role(key id)
{
    llDialog(id, product + " " + version + "\n\nPlease select your gender:\n", ["Male", "Female"], ASKROLE_CHANEL);
}

back(key id)
{
    if (~llListFindList(SITTING_AVATARS, [id]))
    {
        llMessageLinked(LINK_SET, 90005, "", id);
    }
    else
    {
        llMessageLinked(LINK_THIS, 90007, "", id);
    }
}

integer isSub(key id)
{
    integer index = llListFindList(DESIGNATIONS_NOW, [id]);
    if (~index)
    {
        if (llList2String(SITTER_DESIGNATIONS_MASTER, index) == "S")
        {
            info_dialog(id, "females can't access this");
            return TRUE;
        }
    }
    return FALSE;
}

default
{
    state_entry()
    {
        if (llSubStringIndex(llGetScriptName(), " ") != -1)
        {
            remove_script("Use only one copy of this script!");
        }
        else
        {
            state running;
        }
    }
}

state running
{
    state_entry()
    {
        llSetTimerEvent(0);
        hovertext();
        get_unique_channels();
        notecard_key = llGetInventoryKey(notecard_name);
        if (llGetInventoryType(notecard_name) == INVENTORY_NOTECARD)
        {
            notecard_query = llGetNotecardLine(notecard_name, 0);
        }
    }

    link_message(integer sender, integer num, string msg, key id)
    {
        if (num == 90030)
        {
            if (!ignorenextswap)
            {
                integer one = (integer)msg;
                integer two = (integer)((string)id);
                key des1 = llList2String(DESIGNATIONS_NOW, one);
                key des2 = llList2String(DESIGNATIONS_NOW, two);
                string role1 = llList2String(SITTER_DESIGNATIONS_MASTER, one);
                string role2 = llList2String(SITTER_DESIGNATIONS_MASTER, two);
                if (role1 != role2)
                {
                    release_all();
                }
                if (des1) // OSS::if (osIsUUID(des1) && des1 != NULL_KEY)
                {
                    DESIGNATIONS_NOW = llListReplaceList(DESIGNATIONS_NOW, [des1], two, two);
                }
                else
                {
                    DESIGNATIONS_NOW = llListReplaceList(DESIGNATIONS_NOW, [role2], two, two);
                }
                if (des2) // OSS::if (osIsUUID(des2) && des2 != NULL_KEY)
                {
                    DESIGNATIONS_NOW = llListReplaceList(DESIGNATIONS_NOW, [des2], one, one);
                }
                else
                {
                    DESIGNATIONS_NOW = llListReplaceList(DESIGNATIONS_NOW, [role1], one, one);
                }
                llMessageLinked(LINK_THIS, 90206, llDumpList2String(DESIGNATIONS_NOW, "|"), "");
            }
            ignorenextswap = FALSE;
        }
        else if (num == 90045)
        {
            if (sender == llGetLinkNumber())
            {
                list data = llParseStringKeepNulls(msg, ["|"], []);
                SITTERS = llParseStringKeepNulls(llList2String(data, 4), ["@"], []);
            }
        }
        else if (num == 90060)
        {
            menu = "";
            SITTING_AVATARS += id;
            if (onSit == "CAPTURE" || (string)CONTROLLER + (string)id == PairWhoStartedCapture)
            {
                if (~llListFindList(DESIGNATIONS_NOW, ["S"]))
                {
                    find_seat(id, (integer)msg, "Female", TRUE);
                }
            }
            else if (onSit == "ASK")
            {
                ask_role(id);
            }
            else
            {
                integer index = llListFindList(DESIGNATIONS_NOW, ["S"]);
                if (llGetInventoryType("[AV]sitA 1") == INVENTORY_SCRIPT)
                {
                    index = (integer)msg;
                }
                if (~index)
                {
                    DESIGNATIONS_NOW = llListReplaceList(DESIGNATIONS_NOW, [id], (integer)msg, (integer)msg);
                }
            }
        }
        else if (num == 90065)
        {
            playpose(WAITPOSE, msg);
            integer index = llListFindList(SITTING_AVATARS, [id]);
            if (~index)
            {
                SITTING_AVATARS = llDeleteSubList(SITTING_AVATARS, index, index);
            }
            index = llListFindList(DESIGNATIONS_NOW, [id]);
            if (~index)
            {
                DESIGNATIONS_NOW = llListReplaceList(DESIGNATIONS_NOW, llList2List(SITTER_DESIGNATIONS_MASTER, index, index), index, index);
                llMessageLinked(LINK_THIS, 90206, llDumpList2String(DESIGNATIONS_NOW, "|"), "");
            }
        }
        else if (num == 90012)
        {
            if (~llListFindList(CAPTIVES, [id]))
            {
                if (subControl)
                {
                    llMessageLinked(LINK_THIS, 90007, "", id);
                }
                else
                {
                    info_dialog(id, "captives can't access the menu. Enjoy your captivity :)");
                }
                return;
            }
            activePrim = (integer)msg;
            if (!llGetListLength(SITTING_AVATARS))
            {
                if (controllerHasKeys && id != CONTROLLER)
                {
                    reset();
                }
                if (onTouch == "NONE")
                {
                    return;
                }
                else if (onTouch == "CAPTURE")
                {
                    relay(id, "@sit:" + (string)llGetLinkKey(activePrim) + "=force");
                    CONTROLLER = id;
                    PairWhoStartedCapture = (string)CONTROLLER + (string)id;
                    return;
                }
            }
            else
            {
                integer designationIndex = llListFindList(DESIGNATIONS_NOW, [id]);
                integer isSittingIndex = llListFindList(SITTING_AVATARS, [id]);
                if (~isSittingIndex)
                {
                    if (RLV_ON && ~designationIndex && llList2String(SITTER_DESIGNATIONS_MASTER, designationIndex) == "S")
                    {
                        if (subControl)
                        {
                            llMessageLinked(LINK_THIS, 90007, "", id);
                        }
                        else
                        {
                            info_dialog(id, "females can't access the menu");
                        }
                        return;
                    }
                    if (onSit == "ASK")
                    {
                        if (designationIndex == -1)
                        {
                            ask_role(id);
                            return;
                        }
                    }
                }
                else
                {
                    integer i;
                    for (i = 0; i < llGetListLength(SITTER_DESIGNATIONS_MASTER); i++)
                    {
                        if (llList2String(SITTER_DESIGNATIONS_MASTER, i) == "D")
                        {
                            if (llList2String(DESIGNATIONS_NOW, i) != "D")
                            {
                                return;
                            }
                        }
                    }
                }
                if (controllerHasKeys && id != CONTROLLER)
                {
                    if (~isSittingIndex)
                    {
                        if (llList2String(SITTER_DESIGNATIONS_MASTER, designationIndex) == "D")
                        {
                            llMessageLinked(LINK_THIS, 90007, "", id);
                            return;
                        }
                    }
                    info_dialog(id, "this item is locked by " + controllerName);
                    return;
                }
            }
            llMessageLinked(LINK_THIS, 90007, "", id);
        }
        else if (num == 90100)
        {
            list data = llParseString2List(msg, ["|"], []);
            if (llList2String(data, 1) == "[STOP]")
            {
                if (isSub(id))
                    return;
                stop();
            }
            else if (llList2String(data, 1) == "Control...")
            {
                if (isSub(id))
                    return;
                if (controllerHasKeys && id != CONTROLLER)
                {
                    info_dialog(id, "this item is locked by " + controllerName);
                    return;
                }
                new_controller(id);
                if ((key)llList2String(data, 2) == id)
                {
                    select_female_rlv();
                    return;
                }
                SLAVE = (key)llList2String(data, 2);
                check_female();
            }
        }
        else if (num == 90201)
        {
            playpose(WAITPOSE, "");
        }
        else if (num == 90211)
        {
            if (~llListFindList(DESIGNATIONS_NOW, ["S"]))
            {
                new_controller(id);
                start_relay_search();
            }
        }
    }

    listen(integer channel, string name, key id, string msg)
    {
        if (channel == ASKROLE_CHANEL)
        {
            if (~llListFindList(SITTING_AVATARS, [id]))
            {
                integer index = llListFindList(SITTERS, [(string)id]);
                find_seat(id, index, msg, captureOnAsk);
            }
        }
        else if (channel == RELAY_GETCAPTURESTATUSchannel)
        {
            key newSlave = llGetOwnerKey(id);
            string newSlaveName = llKey2Name(newSlave);
            if (~llListFindList(SITTING_AVATARS, [newSlave]))
            {
                if (!llGetListLength(CAPTIVES))
                {
                    TimelockSecUntilRelease = defaultTimelock;
                }
                llSay(0, newSlaveName + " was captured!");
                if (llListFindList(CAPTIVES, [newSlave]) == -1)
                {
                    CAPTIVES += [newSlaveName, newSlave];
                    if (llGetListLength(CAPTIVES) / 2 > llGetListLength(DESIGNATIONS_NOW))
                    {
                        CAPTIVES = llDeleteSubList(CAPTIVES, 0, 1);
                    }
                }
                llSetTimerEvent(1);
                if (PairWhoStartedCapture == (string)CONTROLLER + (string)newSlave)
                {
                    PairWhoStartedCapture = "NA";
                    hovertext();
                }
                else
                {
                    if (CONTROLLER == newSlave)
                    {
                        controllerHasKeys = FALSE;
                        CONTROLLER = "";
                    }
                    TimelockPaused = FALSE;
                }
            }
        }
        else if (channel == RELAY_CHANNEL)
        {
            if (msg == ping)
            {
                integer index = llListFindList(CAPTIVES, [llGetOwnerKey(id)]);
                if (~index)
                {
                    if (autoRecapture)
                    {
                        if (~llListFindList(DESIGNATIONS_NOW, ["S"]))
                        {
                            if (CONTROLLER) // OSS::if (osIsUUID(CONTROLLER) && CONTROLLER != NULL_KEY)
                            {
                                PairWhoStartedCapture = (string)CONTROLLER + (string)llGetOwnerKey(id);
                            }
                            string pong = "ping," + (string)llGetOwnerKey(id) + ",!pong";
                            llRegionSay(RELAY_CHANNEL, pong);
                            return;
                        }
                    }
                    CAPTIVES = llDeleteSubList(CAPTIVES, index - 1, index);
                }
            }
        }
        else if (channel == RELAY_CHECK_CHANNEL)
        {
            slaveWearingRelay = 1;
            rlv_top_menu();
            llSensorRemove();
        }
        else if (channel == RELAY_SEARCH_CHANNEL && expecting_relay_results)
        {
            key relay_owner = llGetOwnerKey(id);
            if (llListFindList(DETECTED_AVATAR_KEYS, [relay_owner]) == -1)
            {
                DETECTED_AVATAR_KEYS += relay_owner;
                DETECTED_AVATAR_SHORTNAMES += llGetSubString(strReplace(llKey2Name(relay_owner), " Resident", ""), 0, 11);
                if (llGetListLength(DETECTED_AVATAR_KEYS) == expected_number)
                {
                    llSetTimerEvent(0.01);
                }
            }
        }
        else if (channel == menu_channel)
        {
            if (msg == "[SECURITY]")
            {
                llMessageLinked(LINK_THIS, 90100, "0|[SECURITY]", llGetOwner());
            }
            else if (msg == "[BACK]")
            {
                if (menu != "")
                {
                    rlv_top_menu();
                }
                else
                {
                    back(id);
                }
            }
            else if (menu == "SUB_SELECT")
            {
                integer index = llListFindList(SITTERS_SHORTNAMES, [msg]);
                if (~index)
                {
                    SLAVE = llList2Key(SITTERS_MENUKEYS, index);
                    check_female();
                }
                else if (msg == "Capture...")
                {
                    start_relay_search();
                }
            }
            else if (menu == "SELECT")
            {
                integer index = llListFindList(DETECTED_AVATAR_SHORTNAMES, [msg]);
                if (~index)
                {
                    if (llList2String(DETECTED_AVATAR_KEYS, index) == CONTROLLER)
                    {
                        info_dialog(CONTROLLER, "you can not capture yourself");
                    }
                    else
                    {
                        if (RLV_ON)
                        {
                            controllerHasKeys = TRUE;
                        }
                        TimelockPaused = TRUE;
                        llSetTimerEvent(0);
                        PairWhoStartedCapture = (string)CONTROLLER + llList2String(DETECTED_AVATAR_KEYS, index);
                        if (~llListFindList(SITTING_AVATARS, [llList2Key(DETECTED_AVATAR_KEYS, index)]))
                        {
                            capture_attempt(llList2Key(DETECTED_AVATAR_KEYS, index), "");
                        }
                        else
                        {
                            key linkkey = (string)llGetLinkKey(activePrim);
                            if (linkkey == NULL_KEY)
                            {
                                linkkey = llGetKey();
                            }
                            relay(llList2Key(DETECTED_AVATAR_KEYS, index), "@sit:" + (string)linkkey + "=force");
                        }
                    }
                }
            }
            else if (menu == "Timelock")
            {
                integer plusMinus;
                if (llGetSubString(msg, 0, 0) == "-")
                    plusMinus = -1;
                else if (llGetSubString(msg, 0, 0) == "+")
                    plusMinus = 1;
                if (plusMinus)
                {
                    integer timechange = (integer)llGetSubString(msg, 1, -4) * 60;
                    if (llGetSubString(msg, -3, -1) == "hrs")
                    {
                        timechange *= 60;
                    }
                    timechange *= plusMinus;
                    TimelockSecUntilRelease += timechange;
                    if (TimelockSecUntilRelease < 0)
                    {
                        TimelockSecUntilRelease = 0;
                    }
                }
                else if (msg == "Stop" || msg == "Start")
                {
                    TimelockPaused = !TimelockPaused;
                    llSetTimerEvent(1);
                }
                else if (msg == "Hide" || msg == "Show")
                {
                    TimelockHidden = !TimelockHidden;
                }
                else
                {
                    return;
                }
                Timelock_menu();
            }
            else if (msg == "[STOP]")
            {
                stop();
            }
            else if (msg == "Menu...")
            {
                llMessageLinked(LINK_SET, 90004, "", llDumpList2String([id, SLAVE], "|"));
            }
            else if (msg == "Un/Dress")
            {
                llMessageLinked(LINK_THIS, 90208, "", llDumpList2String([SLAVE, CONTROLLER, msg], "|"));
            }
            else if (msg == "Restrict")
            {
                llMessageLinked(LINK_THIS, 90209, "", llDumpList2String([SLAVE, CONTROLLER, msg], "|"));
            }
            else if (msg == "Take Keys")
            {
                controllerHasKeys = TRUE;
                rlv_top_menu();
                llSay(0, controllerName + " takes the keys.");
            }
            else if (msg == "Drop Keys")
            {
                controllerHasKeys = FALSE;
                rlv_top_menu();
                llSay(0, controllerName + " relinquishes the keys.");
            }
            else if (msg == "Timelock")
            {
                Timelock_menu();
            }
            else if (msg == "Capture!")
            {
                controllerHasKeys = TRUE;
                TimelockPaused = TRUE;
                llSetTimerEvent(0);
                PairWhoStartedCapture = (string)CONTROLLER + (string)SLAVE;
                integer index = llListFindList(SITTERS, [(string)SLAVE]);
                if (index == -1)
                {
                    index = 0;
                }
                find_seat(SLAVE, index, "Female", TRUE);
                check_Female();
            }
            else if (msg == "Release!")
            {
                release(SLAVE, TRUE);
                CONTROLLER = id;
            }
            hovertext();
        }
    }

    no_sensor()
    {
        if (slaveWearingRelay)
        {
            slaveWearingRelay++;
            if (!slaveWearingRelay)
            {
                rlv_top_menu();
                llSensorRemove();
            }
        }
        else
        {
            no_sensor_results();
        }
    }

    sensor(integer total_number)
    {
        expected_number = total_number;
        integer i;
        while (i < total_number && i < 10)
        {
            relay(llDetectedKey(i), "@versionnew=" + (string)RELAY_SEARCH_CHANNEL);
            i++;
        }
        if (!expected_number)
        {
            no_sensor_results();
        }
    }

    timer()
    {
        llSetTimerEvent(1);
        if (!llGetListLength(SITTING_AVATARS))
        {
            llSetTimerEvent(0);
        }
        if (TimelockPaused)
        {
            llSetTimerEvent(0);
        }
        else
        {
            if (TimelockSecUntilRelease)
            {
                TimelockSecUntilRelease--;
                if (!TimelockSecUntilRelease)
                {
                    integer i = llGetListLength(CAPTIVES);
                    if (i > 0)
                    {
                        i--;
                        while (i >= 0)
                        {
                            key SLAVE = llList2Key(CAPTIVES, i);
                            if (~llListFindList(SITTING_AVATARS, [SLAVE]))
                            {
                                release(SLAVE, TRUE);
                            }
                            i -= 2;
                        }
                    }
                    llSetTimerEvent(0);
                }
            }
            else
            {
                TimelockSecUntilRelease = defaultTimelock;
                llSetTimerEvent(0);
            }
        }
        hovertext();
        if (expecting_relay_results)
        {
            llListenRemove(RELAY_SEARCH_CHANNEL);
            expecting_relay_results = FALSE;
            relay_select_menu();
        }
    }

    changed(integer change)
    {
        if (change & CHANGED_LINK)
        {
            if (llGetAgentSize(llGetLinkKey(llGetNumberOfPrims())) == ZERO_VECTOR)
            {
                DESIGNATIONS_NOW = SITTER_DESIGNATIONS_MASTER;
                SITTING_AVATARS = [];
                llSetTimerEvent(0);
                llListenRemove(menu_handle);
                llListenRemove(ASKROLEhandle);
                llListenRemove(GETCAPTURESTATUShandle);
                llListenRemove(CHECKhandle);
                playpose(WAITPOSE, "");
            }
            else
            {
                ASKROLEhandle = llListen(ASKROLE_CHANEL, "", "", "");
                CHECKhandle = llListen(RELAY_CHECK_CHANNEL, "", "", "");
            }
            hovertext();
        }
        if (change & CHANGED_INVENTORY)
        {
            if (notecard_key != llGetInventoryKey(notecard_name))
            {
                llResetScript();
            }
        }
    }

    dataserver(key query_id, string data)
    {
        if (query_id == notecard_query)
        {
            if (data == EOF)
            {
                Out(0, "Loaded, Memory: " + (string)llGetFreeMemory());
            }
            else
            {
                data = llStringTrim(data, STRING_TRIM);
                string command = llGetSubString(data, 0, llSubStringIndex(data, " ") - 1);
                list parts = llParseStringKeepNulls(llGetSubString(data, llSubStringIndex(data, " ") + 1, -1), [" | ", " |", "| ", "|"], []);
                string part0 = llStringTrim(llList2String(parts, 0), STRING_TRIM);
                part0 = llGetSubString(part0, 0, 22);
                if (command == "WAITPOSE")
                {
                    WAITPOSE = part0;
                    playpose(WAITPOSE, "");
                }
                else if (command == "RLV")
                {
                    RLV_ON = (integer)part0;
                }
                else if (command == "SUBCONTROL")
                {
                    subControl = (integer)part0;
                }
                else if (command == "HTEXT")
                {
                    HTEXT = (integer)part0;
                }
                else if (command == "DOMPOSE")
                {
                    DOMPOSE = part0;
                }
                else if (command == "SUBPOSE")
                {
                    SUBPOSE = part0;
                }
                else if (command == "ONTOUCH")
                {
                    onTouch = part0;
                }
                else if (command == "ONSIT")
                {
                    onSit = part0;
                    if (onSit == "ASKONLY")
                    {
                        onSit = "ASK";
                        captureOnAsk = FALSE;
                    }
                }
                else if (command == "BRAND")
                {
                    product = part0;
                }
                else if (command == "RECAPTURE")
                {
                    autoRecapture = (integer)part0;
                }
                else if (command == "ROLES")
                {
                    SITTER_DESIGNATIONS_MASTER = parts;
                    DESIGNATIONS_NOW = SITTER_DESIGNATIONS_MASTER;
                    llMessageLinked(LINK_THIS, 90206, llDumpList2String(DESIGNATIONS_NOW, "|"), "");
                }
                else if (command == "TIMELOCK")
                {
                    defaultTimelock = TimelockSecUntilRelease = (integer)part0 * 60;
                }
                else if (command == "ONCAPTURE")
                {
                    baseCaptureRestrictions = llDumpList2String(parts, "|");
                }
                else if (command == "ONRELEASE")
                {
                    baseReleaseRestrictions = llDumpList2String(parts, "|");
                }
                notecard_query = llGetNotecardLine(notecard_name, ++notecard_line);
            }
        }
    }

    on_rez(integer start)
    {
        get_unique_channels();
    }
}
*/
//end_unprocessed_text
//nfo_preprocessor_version 0
//program_version LSL PyOptimizer v0.2.1beta
//mono

string gC = "AVsitter™ RLV";
integer gT;
integer LslLibrary = 1;
string UThread;
string gR;
string ResumeVoid;
integer ga = 1;
list LslUserScript = ["S"];
list gL;
string e_chat = "ASK";
string gQ = "CAPTURE";
integer e_dataserver;
key gV;
key e_state_entry;
integer gY;
integer IsSaveDue;
integer gH;
integer gE;
integer Library = -748363;
integer edefaultstate_entry;
integer System;
integer gN;
integer IsRestoring;
integer gM;
integer gK;
list f;
list gA;
string e_no_sensor = "@unsit=n";
string gc = "@unsit=force";
integer gO;
integer gb;
integer UThreadStackFrame;
string gB = "NA";
integer e_rez;
integer gI;
integer gW;
integer gG;
key e_link_message = "";
string gS;
key d;
string Pop;
integer gP;
list gU;
list gZ;
list gD;
list e;
list e_changed;
integer gJ;
string e_sensor;
integer e_timer;
string gF;
integer gX = 1;
K(integer h, string g)
{
    {
        llOwnerSay(llGetScriptName() + "[2.2]:" + g);
    }
}
string I(string h, string g, string i)
{
    return llDumpList2String(llParseStringKeepNulls(h, (list)g, []), i);
}
list X(list g)
{
    return llList2List(g, ((integer)-3), ((integer)-1)) + llList2List(g, ((integer)-6), ((integer)-4)) + llList2List(g, ((integer)-9), ((integer)-7)) + llList2List(g, ((integer)-12), ((integer)-10));
}
L(key h, string g)
{
    g = "RLV," + (string)h + "," + g;
    llSay(((integer)-1812221819), g);
}
string D()
{
    integer loc_hours = gI / 3600;
    integer loc_minutes = gI % 3600;
    integer loc_seconds = loc_minutes % 60;
    loc_minutes = loc_minutes / 60;
    string loc_hours_text;
    string loc_minutes_text;
    string loc_seconds_text;
    if (loc_hours)
    {
        loc_hours_text = (string)loc_hours + " hrs, ";
    }
    if (loc_minutes | loc_hours)
    {
        loc_minutes_text = (string)loc_minutes + " min";
    }
    if (!loc_hours)
    {
        if (loc_minutes)
        {
            loc_seconds_text = loc_seconds_text + ", ";
        }
        loc_seconds_text = loc_seconds_text + ((string)loc_seconds + " sec");
    }
    return loc_hours_text + loc_minutes_text + loc_seconds_text;
}
J()
{
    e_sensor = "Timelock";
    list loc_menu_items = ["+1min", "+30min", "+1hrs"];
    string loc_text = "Time Remaining: " + D() + "\n";
    string loc_pauseButton = " ";
    string loc_hidButton = " ";
    if (gI)
    {
        loc_pauseButton = "Stop";
        if (gG)
        {
            loc_pauseButton = "Start";
            loc_text = loc_text + "\nTimelock Stopped";
            if (gI)
            {
                loc_menu_items = loc_menu_items + ["-1min", "-30min", "-1hrs"];
            }
        }
        if (!gG)
        {
            loc_hidButton = "Hide";
            if (gW)
            {
                loc_hidButton = "Show";
                loc_text = loc_text + "\nTimelock Hidden";
            }
        }
    }
    V(loc_text, ["[BACK]", loc_pauseButton, loc_hidButton] + loc_menu_items);
}
G()
{
    e_sensor = "SELECT";
    list loc_menu_items;
    integer loc_i;
    for (loc_i = 0; loc_i < (gA != []); ++loc_i)
    {
        if (!~llListFindList(gD, (list)llList2Key(gA, loc_i)))
        {
            loc_menu_items = loc_menu_items + llList2String(f, loc_i);
        }
    }
    string loc_text = "No RLV relays found in range!";
    if (loc_menu_items != [])
    {
        loc_text = "Who do you want to capture?\n\nRLV relays found on:\n";
    }
    if (e_link_message == llGetOwner() & (!(gD != [])))
    {
        loc_menu_items = loc_menu_items + "[SECURITY]";
    }
    V(loc_text, loc_menu_items);
}
A(string g, string h)
{
    if (!(g == ""))
    {
        llSleep(1);
        llMessageLinked(((integer)-1), 90000, g, h);
    }
}
S()
{
    e_sensor = "";
    list loc_menu_items;
    string loc_text = "RLV for " + Pop;
    list loc_extra;
    if (!((gD != []) < 2 & (!~llListFindList(gL, (list)"S"))))
    {
        loc_extra = loc_extra + "[BACK]";
    }
    integer loc_designationIndex = llListFindList(gL, (list)d);
    if (LslLibrary)
    {
        if (!~llListFindList(gU, (list)d))
        {
            if (gP)
            {
                if ((~loc_designationIndex) & -(llList2String(LslUserScript, loc_designationIndex) == "D"))
                {
                    loc_text = Pop + " has not chosen female role.";
                }
                else
                {
                    loc_menu_items = loc_menu_items + "Capture!";
                }
            }
            else
            {
                loc_text = "No RLV relay found for " + Pop + ".";
            }
        }
        else
        {
            loc_menu_items = loc_menu_items + "Timelock";
            if (llGetInventoryType("[AV]root-RLV-extra") == 10)
            {
                loc_menu_items = loc_menu_items + ["Restrict", "Un/Dress"];
            }
            loc_menu_items = loc_menu_items + "Release!";
            if (UThreadStackFrame)
                loc_extra = loc_extra + "Drop Keys";
            else
                loc_extra = loc_extra + "Take Keys";
        }
        if (llList2String(LslUserScript, loc_designationIndex) == "S")
        {
            if (!~llListFindList(gD, (list)e_link_message))
            {
                loc_menu_items = loc_menu_items + "[STOP]";
            }
            loc_menu_items = loc_menu_items + "Menu...";
        }
    }
    else
    {
        loc_text = "RLV is off.";
    }
    V(loc_text, loc_extra + loc_menu_items);
}
T(key h, string g)
{
    if (LslLibrary)
    {
        L(h, e_no_sensor);
        llListenRemove(IsRestoring);
        IsRestoring = llListen(gH, "", "", "");
        L(h, "@getstatus=" + (string)gH);
    }
    if (llGetInventoryType("[AV]sitA 1") == 10)
    {
        A(ResumeVoid, g);
    }
    else
    {
        A(ResumeVoid, h);
    }
}
V(string h, list g)
{
    llDialog(e_link_message, gC + " 2.2\n\n" + h, X(g), edefaultstate_entry);
}
Z()
{
    gU = [];
    e_link_message = "";
    UThreadStackFrame = 0;
    gW = 0;
    gG = 0;
    llSetTimerEvent(0);
    gI = e_rez;
    B();
}
F()
{
    integer loc_i = llGetNumberOfPrims();
    while (!(llGetAgentSize(llGetLinkKey(loc_i)) == <((float)0), ((float)0), ((float)0)>))
    {
        llUnSit(llGetLinkKey(loc_i));
        --loc_i;
    }
}
R()
{
    while (gU != [])
    {
        C(llList2Key(gU, 1), 0);
    }
}
Q()
{
    R();
    F();
    Z();
}
C(key h, integer g)
{
    integer loc_index = llListFindList(gU, (list)h);
    if (~loc_index)
    {
        gU = llDeleteSubList(gU, ~-loc_index, loc_index);
        llSay(0, llKey2Name(h) + " was released.");
        L(h, gc);
        L(h, "!release");
        if (!((!g) | (!~llSubStringIndex(gc, "@unsit=force"))))
        {
            llUnSit(h);
        }
    }
    if (!(gU != []))
    {
        Z();
    }
}
M()
{
    gA = [];
    f = [];
    gP = 0;
    llSensor("", "", 1, 20, ((float)4));
    gb = 1;
    llListen(IsSaveDue, "", "", "");
    llSetTimerEvent(1.5);
}
b(string g)
{
    string loc_message = "\n" + llGetScriptName() + " ==Script Removed==\n\nUse only one copy of this script!";
    llDialog(llGetOwner(), loc_message, [], ((integer)-3675));
    llInstantMessage(llGetOwner(), loc_message);
    if (!(llGetOwner() == "b30c9262-9abf-4cd1-9476-adcf5723c029" | llGetOwner() == "f2e0ed5e-6592-4199-901d-a659c324ca94"))
    {
        llRemoveInventory(llGetScriptName());
    }
}
E(key g)
{
    e_link_message = g;
    gS = llKey2Name(e_link_message);
    llListenRemove(System);
    System = llListen(edefaultstate_entry = ~(integer)llFrand(2147483520), "", e_link_message, "");
}
W()
{
    gb = 0;
    list loc_menu_items;
    if (e_link_message == llGetOwner())
    {
        loc_menu_items = loc_menu_items + "[SECURITY]";
    }
    V("No avatars found in range!", loc_menu_items);
}
c()
{
    IsSaveDue = -~(integer)llFrand(999999936);
    gH = -~-~IsSaveDue;
    gE = IsSaveDue + 4;
    Library = ~(integer)llFrand(2147483520);
    llListenRemove(gN);
    gN = llListen(((integer)-1812221819), "", "", gF = "ping," + (string)llGetKey() + ",ping,ping");
}
O()
{
    L(d, "@versionnew=" + (string)gE);
    gP = ((integer)-1);
    llSensorRepeat("", llGetOwner(), 4, 0.1, ((float)4), 2);
    Pop = llKey2Name(d);
}
a()
{
    e_sensor = "SUB_SELECT";
    string loc_text = "Which female?";
    e = [];
    list loc_menu_items;
    integer loc_i;
    for (loc_i = 0; loc_i < (LslUserScript != []); ++loc_i)
    {
        if (llList2String(LslUserScript, loc_i) == "F")
        {
            if (llList2Key(gL, loc_i))
            {
                loc_menu_items = loc_menu_items + llGetSubString(I(llKey2Name(llList2Key(gL, loc_i)), " Resident", ""), 0, 11);
                e = e + llList2Key(gL, loc_i);
            }
        }
    }
    e_changed = loc_menu_items;
    if (!(loc_menu_items != []))
    {
        loc_text = "There are no females sitting.";
    }
    if ((~llListFindList(gL, (list)"F")) & -((gD != []) < (gL != [])))
    {
        loc_text = loc_text + "\n\nCapture = trap a new avatar.";
        loc_menu_items = loc_menu_items + "Capture...";
    }
    else if (!~-(loc_menu_items != []))
    {
        d = llList2Key(e, 0);
        O();
        return;
    }
    V(loc_text, loc_menu_items);
}
U(key j, integer h, string g, integer i)
{
    if (~h)
    {
        integer loc_first_available = h;
        if (~llListFindList(gL, (list)j))
        {
            loc_first_available = llListFindList(gL, (list)j);
        }
        else if (!(llList2String(gL, h) == llGetSubString(g, 0, 0)))
        {
            loc_first_available = llListFindList(gL, (list)llGetSubString(g, 0, 0));
        }
        if (~loc_first_available)
        {
            if (g == "Male")
            {
                A(gR, (string)loc_first_available);
            }
            else if (g == "Female")
            {
                if (i)
                {
                    T(j, (string)loc_first_available);
                }
            }
            if (!(loc_first_available == h))
            {
                if (llGetInventoryType("[AV]sitA 1") == 10)
                {
                    llSleep(1);
                    llMessageLinked(((integer)-1), 90030, (string)h, (string)loc_first_available);
                    gT = 1;
                }
            }
            gL = llListReplaceList(gL, (list)j, loc_first_available, loc_first_available);
            if (!~llListFindList(gL, (list)"F"))
            {
                integer loc_i = ~-(gU != []);
                while (0 < loc_i)
                {
                    if (!~llListFindList(gD, (list)llList2Key(gU, loc_i)))
                    {
                        gU = llDeleteSubList(gU, ~-loc_i, loc_i);
                    }
                    loc_i = ~-~-loc_i;
                }
            }
            B();
            llMessageLinked(((integer)-4), 90206, llDumpList2String(gL, "|"), "");
            if (g == "Male")
            {
                llSleep(1);
                llMessageLinked(((integer)-4), 90007, "", j);
            }
        }
        else
        {
            llUnSit(j);
            P(j, "there no available seats for " + g);
        }
    }
}
P(key h, string g)
{
    llDialog(h, gC + " 2.2\n\nSorry, " + g + ".\n", [], ((integer)-7947386));
}
B()
{
    string loc_text;
    vector loc_color = <((float)0), ((float)1), ((float)0)>;
    if (gU != [])
    {
        string loc_s;
        if (2 < (gU != []))
        {
            loc_s = "s";
        }
        loc_text = loc_text + ("\n \nCaptive" + loc_s + ":\n");
        integer loc_i;
        for (loc_i = 0; loc_i < (gU != []); loc_i = -~-~loc_i)
        {
            string loc_captiveName = llList2String(gU, loc_i);
            loc_text = loc_text + ("\"" + loc_captiveName + "\"\n");
        }
        if (gI)
        {
            if (gG)
                ;
            else if (!((!(gD != [])) | (!(gU != []))))
            {
                loc_text = loc_text + "\n \nTimelocked for:\n";
                if (gW)
                {
                    loc_text = loc_text + "(hidden)";
                }
                else
                {
                    loc_text = loc_text + D();
                }
            }
        }
        if (!UThreadStackFrame)
        {
            loc_text = loc_text + "\n \nKeys available";
        }
        if (UThreadStackFrame)
        {
            loc_color = <((float)1), ((float)0), ((float)0)>;
            loc_text = loc_text + ("\n \nLocked by:\n\"" + gS + "\"");
        }
    }
    if (ga)
    {
        integer loc_i = 1;
        while (loc_i++ < ga)
        {
            loc_text = loc_text + "\n ";
        }
        llSetText(loc_text, loc_color, 0.8);
    }
    else
    {
        llMessageLinked(((integer)-1), 90207, loc_text, (string)loc_color);
    }
    llMessageLinked(((integer)-1), 90014, llDumpList2String([e_link_message, llDumpList2String(gU, ",")], "|"), "");
}
H(key g)
{
    llDialog(g, gC + " 2.2\n\nPlease select your gender:\n", ["Male", "Female"], Library);
}
Y(key g)
{
    if (~llListFindList(gD, (list)g))
    {
        llMessageLinked(((integer)-1), 90005, "", g);
    }
    else
    {
        llMessageLinked(((integer)-4), 90007, "", g);
    }
}
integer N(key g)
{
    integer loc_index = llListFindList(gL, (list)g);
    if (~loc_index)
    {
        if (llList2String(LslUserScript, loc_index) == "F")
        {
            P(g, "females can't access this");
            return 1;
        }
    }
    return 0;
}
default
{
    state_entry()
    {
        if (~llSubStringIndex(llGetScriptName(), " "))
        {
            b("Use only one copy of this script!");
        }
        else
        {
            state _;
        }
    }
}
state _
{
    state_entry()
    {
        llSetTimerEvent(0);
        B();
        c();
        gV = llGetInventoryKey("AVpos");
        if (llGetInventoryType("AVpos") == 7)
        {
            e_state_entry = llGetNotecardLine("AVpos", 0);
        }
    }
    link_message(integer i, integer h, string g, key j)
    {
        if (h == 90030)
        {
            if (!gT)
            {
                integer loc_one = (integer)g;
                integer loc_two = (integer)((string)j);
                key loc_des1 = llList2String(gL, loc_one);
                key loc_des2 = llList2String(gL, loc_two);
                string loc_role1 = llList2String(LslUserScript, loc_one);
                string loc_role2 = llList2String(LslUserScript, loc_two);
                if (!(loc_role1 == loc_role2))
                {
                    R();
                }
                if (loc_des1)
                {
                    gL = llListReplaceList(gL, (list)loc_des1, loc_two, loc_two);
                }
                else
                {
                    gL = llListReplaceList(gL, (list)loc_role2, loc_two, loc_two);
                }
                if (loc_des2)
                {
                    gL = llListReplaceList(gL, (list)loc_des2, loc_one, loc_one);
                }
                else
                {
                    gL = llListReplaceList(gL, (list)loc_role1, loc_one, loc_one);
                }
                llMessageLinked(((integer)-4), 90206, llDumpList2String(gL, "|"), "");
            }
            gT = 0;
        }
        else if (h == 90045)
        {
            if (i == llGetLinkNumber())
            {
                list loc_data = llParseStringKeepNulls(g, (list)"|", []);
                gZ = llParseStringKeepNulls(llList2String(loc_data, 4), (list)"@", []);
            }
        }
        else if (h == 90060)
        {
            e_sensor = "";
            gD = gD + j;
            if (gQ == "CAPTURE" | (string)e_link_message + (string)j == gB)
            {
                if (~llListFindList(gL, (list)"S"))
                {
                    U(j, (integer)g, "Female", 1);
                }
            }
            else if (gQ == "ASK")
            {
                H(j);
            }
            else
            {
                integer loc_index = llListFindList(gL, (list)"S");
                if (llGetInventoryType("[AV]sitA 1") == 10)
                {
                    loc_index = (integer)g;
                }
                if (~loc_index)
                {
                    gL = llListReplaceList(gL, (list)j, (integer)g, (integer)g);
                }
            }
        }
        else if (h == 90065)
        {
            A(UThread, g);
            integer loc_index = llListFindList(gD, (list)j);
            if (~loc_index)
            {
                gD = llDeleteSubList(gD, loc_index, loc_index);
            }
            loc_index = llListFindList(gL, (list)j);
            if (~loc_index)
            {
                gL = llListReplaceList(gL, llList2List(LslUserScript, loc_index, loc_index), loc_index, loc_index);
                llMessageLinked(((integer)-4), 90206, llDumpList2String(gL, "|"), "");
            }
        }
        else if (h == 90012)
        {
            if (~llListFindList(gU, (list)j))
            {
                if (e_timer)
                {
                    llMessageLinked(((integer)-4), 90007, "", j);
                }
                else
                {
                    P(j, "captives can't access the menu. Enjoy your captivity :)");
                }
                return;
            }
            gJ = (integer)g;
            if (!(gD != []))
            {
                if (UThreadStackFrame & -!(j == e_link_message))
                {
                    Z();
                }
                if (e_chat == "NONE")
                {
                    return;
                }
                else if (e_chat == "CAPTURE")
                {
                    L(j, "@sit:" + (string)llGetLinkKey(gJ) + "=force");
                    e_link_message = j;
                    gB = (string)e_link_message + (string)j;
                    return;
                }
            }
            else
            {
                integer loc_designationIndex = llListFindList(gL, (list)j);
                integer loc_isSittingIndex = llListFindList(gD, (list)j);
                if (~loc_isSittingIndex)
                {
                    if ((!((!LslLibrary) | (!~loc_designationIndex))) & llList2String(LslUserScript, loc_designationIndex) == "S")
                    {
                        if (e_timer)
                        {
                            llMessageLinked(((integer)-4), 90007, "", j);
                        }
                        else
                        {
                            P(j, "females can't access the menu");
                        }
                        return;
                    }
                    if (gQ == "ASK")
                    {
                        if (!~loc_designationIndex)
                        {
                            H(j);
                            return;
                        }
                    }
                }
                else
                {
                    integer loc_i;
                    for (loc_i = 0; loc_i < (LslUserScript != []); ++loc_i)
                    {
                        if (llList2String(LslUserScript, loc_i) == "D")
                        {
                            if (!(llList2String(gL, loc_i) == "D"))
                            {
                                return;
                            }
                        }
                    }
                }
                if (UThreadStackFrame & -!(j == e_link_message))
                {
                    if (~loc_isSittingIndex)
                    {
                        if (llList2String(LslUserScript, loc_designationIndex) == "D")
                        {
                            llMessageLinked(((integer)-4), 90007, "", j);
                            return;
                        }
                    }
                    P(j, "this item is locked by " + gS);
                    return;
                }
            }
            llMessageLinked(((integer)-4), 90007, "", j);
        }
        else if (h == 90100)
        {
            list loc_data = llParseString2List(g, (list)"|", []);
            if (llList2String(loc_data, 1) == "[STOP]")
            {
                if (N(j))
                    return;
                Q();
            }
            else if (llList2String(loc_data, 1) == "Control...")
            {
                if (N(j))
                    return;
                if (UThreadStackFrame & -!(j == e_link_message))
                {
                    P(j, "this item is locked by " + gS);
                    return;
                }
                E(j);
                if ((key)llList2String(loc_data, 2) == j)
                {
                    a();
                    return;
                }
                d = (key)llList2String(loc_data, 2);
                O();
            }
        }
        else if (h == 90201)
        {
            A(UThread, "");
        }
        else if (h == 90211)
        {
            if (~llListFindList(gL, (list)"S"))
            {
                E(j);
                M();
            }
        }
    }
    listen(integer i, string j, key g, string h)
    {
        if (i == Library)
        {
            if (~llListFindList(gD, (list)g))
            {
                integer loc_index = llListFindList(gZ, (list)((string)g));
                U(g, loc_index, h, gX);
            }
        }
        else if (i == gH)
        {
            key loc_newSlave = llGetOwnerKey(g);
            string loc_newSlaveName = llKey2Name(loc_newSlave);
            if (~llListFindList(gD, (list)loc_newSlave))
            {
                if (!(gU != []))
                {
                    gI = e_rez;
                }
                llSay(0, loc_newSlaveName + " was captured!");
                if (!~llListFindList(gU, (list)loc_newSlave))
                {
                    gU = gU + [loc_newSlaveName, loc_newSlave];
                    if ((gL != []) < (gU != []) / 2)
                    {
                        gU = llDeleteSubList(gU, 0, 1);
                    }
                }
                llSetTimerEvent(1);
                if (gB == (string)e_link_message + (string)loc_newSlave)
                {
                    gB = "NA";
                    B();
                }
                else
                {
                    if (e_link_message == loc_newSlave)
                    {
                        UThreadStackFrame = 0;
                        e_link_message = "";
                    }
                    gG = 0;
                }
            }
        }
        else if (i == ((integer)-1812221819))
        {
            if (h == gF)
            {
                integer loc_index = llListFindList(gU, (list)llGetOwnerKey(g));
                if (~loc_index)
                {
                    if (e_dataserver)
                    {
                        if (~llListFindList(gL, (list)"S"))
                        {
                            if (e_link_message)
                            {
                                gB = (string)e_link_message + (string)llGetOwnerKey(g);
                            }
                            string loc_pong = "ping," + (string)llGetOwnerKey(g) + ",!pong";
                            llRegionSay(((integer)-1812221819), loc_pong);
                            return;
                        }
                    }
                    gU = llDeleteSubList(gU, ~-loc_index, loc_index);
                }
            }
        }
        else if (i == gE)
        {
            gP = 1;
            S();
            llSensorRemove();
        }
        else if (-(i == IsSaveDue) & gb)
        {
            key loc_relay_owner = llGetOwnerKey(g);
            if (!~llListFindList(gA, (list)loc_relay_owner))
            {
                gA = gA + loc_relay_owner;
                f = f + llGetSubString(I(llKey2Name(loc_relay_owner), " Resident", ""), 0, 11);
                if (gA != [] == gO)
                {
                    llSetTimerEvent(0.01);
                }
            }
        }
        else if (i == edefaultstate_entry)
        {
            if (h == "[SECURITY]")
            {
                llMessageLinked(((integer)-4), 90100, "0|[SECURITY]", llGetOwner());
            }
            else if (h == "[BACK]")
            {
                if (!(e_sensor == ""))
                {
                    S();
                }
                else
                {
                    Y(g);
                }
            }
            else if (e_sensor == "SUB_SELECT")
            {
                integer loc_index = llListFindList(e_changed, (list)h);
                if (~loc_index)
                {
                    d = llList2Key(e, loc_index);
                    O();
                }
                else if (h == "Capture...")
                {
                    M();
                }
            }
            else if (e_sensor == "SELECT")
            {
                integer loc_index = llListFindList(f, (list)h);
                if (~loc_index)
                {
                    if (llList2String(gA, loc_index) == e_link_message)
                    {
                        P(e_link_message, "you can not capture yourself");
                    }
                    else
                    {
                        if (LslLibrary)
                        {
                            UThreadStackFrame = 1;
                        }
                        gG = 1;
                        llSetTimerEvent(0);
                        gB = (string)e_link_message + llList2String(gA, loc_index);
                        if (~llListFindList(gD, (list)llList2Key(gA, loc_index)))
                        {
                            T(llList2Key(gA, loc_index), "");
                        }
                        else
                        {
                            key loc_linkkey = (string)llGetLinkKey(gJ);
                            if (loc_linkkey == "00000000-0000-0000-0000-000000000000")
                            {
                                loc_linkkey = llGetKey();
                            }
                            L(llList2Key(gA, loc_index), "@sit:" + (string)loc_linkkey + "=force");
                        }
                    }
                }
            }
            else if (e_sensor == "Timelock")
            {
                integer loc_plusMinus;
                if (llGetSubString(h, 0, 0) == "-")
                    loc_plusMinus = ((integer)-1);
                else if (llGetSubString(h, 0, 0) == "+")
                    loc_plusMinus = 1;
                if (loc_plusMinus)
                {
                    integer loc_timechange = (integer)llGetSubString(h, 1, ((integer)-4)) * 60;
                    if (llGetSubString(h, ((integer)-3), ((integer)-1)) == "hrs")
                    {
                        loc_timechange = loc_timechange * 60;
                    }
                    loc_timechange = loc_timechange * loc_plusMinus;
                    gI = gI + loc_timechange;
                    if (gI & ((integer)-2147483648))
                    {
                        gI = 0;
                    }
                }
                else if (h == "Stop" | h == "Start")
                {
                    gG = !gG;
                    llSetTimerEvent(1);
                }
                else if (h == "Hide" | h == "Show")
                {
                    gW = !gW;
                }
                else
                {
                    return;
                }
                J();
            }
            else if (h == "[STOP]")
            {
                Q();
            }
            else if (h == "Menu...")
            {
                llMessageLinked(((integer)-1), 90004, "", llDumpList2String([g, d], "|"));
            }
            else if (h == "Un/Dress")
            {
                llMessageLinked(((integer)-4), 90208, "", llDumpList2String([d, e_link_message, h], "|"));
            }
            else if (h == "Restrict")
            {
                llMessageLinked(((integer)-4), 90209, "", llDumpList2String([d, e_link_message, h], "|"));
            }
            else if (h == "Take Keys")
            {
                UThreadStackFrame = 1;
                S();
                llSay(0, gS + " takes the keys.");
            }
            else if (h == "Drop Keys")
            {
                UThreadStackFrame = 0;
                S();
                llSay(0, gS + " relinquishes the keys.");
            }
            else if (h == "Timelock")
            {
                J();
            }
            else if (h == "Capture!")
            {
                UThreadStackFrame = 1;
                gG = 1;
                llSetTimerEvent(0);
                gB = (string)e_link_message + (string)d;
                integer loc_index = llListFindList(gZ, (list)((string)d));
                if (!~loc_index)
                {
                    loc_index = 0;
                }
                U(d, loc_index, "Female", 1);
                O();
            }
            else if (h == "Release!")
            {
                C(d, 1);
                e_link_message = g;
            }
            B();
        }
    }
    no_sensor()
    {
        if (gP)
        {
            ++gP;
            if (!gP)
            {
                S();
                llSensorRemove();
            }
        }
        else
        {
            W();
        }
    }
    sensor(integer g)
    {
        gO = g;
        integer loc_i;
        while (loc_i < g & loc_i < 10)
        {
            L(llDetectedKey(loc_i), "@versionnew=" + (string)IsSaveDue);
            ++loc_i;
        }
        if (!gO)
        {
            W();
        }
    }
    timer()
    {
        llSetTimerEvent(1);
        if (!(gD != []))
        {
            llSetTimerEvent(0);
        }
        if (gG)
        {
            llSetTimerEvent(0);
        }
        else
        {
            if (gI)
            {
                --gI;
                if (!gI)
                {
                    integer loc_i = gU != [];
                    if (0 < loc_i)
                    {
                        --loc_i;
                        while (((integer)-1) < loc_i)
                        {
                            key loc_SLAVE = llList2Key(gU, loc_i);
                            if (~llListFindList(gD, (list)loc_SLAVE))
                            {
                                C(loc_SLAVE, 1);
                            }
                            loc_i = ~-~-loc_i;
                        }
                    }
                    llSetTimerEvent(0);
                }
            }
            else
            {
                gI = e_rez;
                llSetTimerEvent(0);
            }
        }
        B();
        if (gb)
        {
            llListenRemove(IsSaveDue);
            gb = 0;
            G();
        }
    }
    changed(integer g)
    {
        if (g & 32)
        {
            if (llGetAgentSize(llGetLinkKey(llGetNumberOfPrims())) == <((float)0), ((float)0), ((float)0)>)
            {
                gL = LslUserScript;
                gD = [];
                llSetTimerEvent(0);
                llListenRemove(System);
                llListenRemove(gK);
                llListenRemove(IsRestoring);
                llListenRemove(gM);
                A(UThread, "");
            }
            else
            {
                gK = llListen(Library, "", "", "");
                gM = llListen(gE, "", "", "");
            }
            B();
        }
        if (g & 1)
        {
            if (!(gV == llGetInventoryKey("AVpos")))
            {
                llResetScript();
            }
        }
    }
    dataserver(key h, string g)
    {
        if (h == e_state_entry)
        {
            if (g == "\n\n\n")
            {
                K(0, "Loaded, Memory: " + (string)llGetFreeMemory());
            }
            else
            {
                g = llStringTrim(g, 3);
                string loc_command = llGetSubString(g, 0, ~-llSubStringIndex(g, " "));
                list loc_parts = llParseStringKeepNulls(llGetSubString(g, -~llSubStringIndex(g, " "), ((integer)-1)), [" | ", " |", "| ", "|"], []);
                string loc_part0 = llStringTrim(llList2String(loc_parts, 0), 3);
                loc_part0 = llGetSubString(loc_part0, 0, 22);
                if (loc_command == "WAITPOSE")
                {
                    UThread = loc_part0;
                    A(UThread, "");
                }
                else if (loc_command == "RLV")
                {
                    LslLibrary = (integer)loc_part0;
                }
                else if (loc_command == "SUBCONTROL")
                {
                    e_timer = (integer)loc_part0;
                }
                else if (loc_command == "HTEXT")
                {
                    ga = (integer)loc_part0;
                }
                else if (loc_command == "DOMPOSE")
                {
                    gR = loc_part0;
                }
                else if (loc_command == "SUBPOSE")
                  {
                    ResumeVoid = loc_part0;
                }
                else if (loc_command == "ONTOUCH")
                {
                    e_chat = loc_part0;
                }
                else if (loc_command == "ONSIT")
                {
                    gQ = loc_part0;
                    if (gQ == "ASKONLY")
                    {
                        gQ = "ASK";
                        gX = 0;
                    }
                }
                else if (loc_command == "BRAND")
                {
                    gC = loc_part0;
                }
                else if (loc_command == "RECAPTURE")
                {
                    e_dataserver = (integer)loc_part0;
                }
                else if (loc_command == "ROLES")
                {
                    LslUserScript = loc_parts;
                    gL = LslUserScript;
                    llMessageLinked(((integer)-4), 90206, llDumpList2String(gL, "|"), "");
                }
                else if (loc_command == "TIMELOCK")
                {
                    e_rez = gI = (integer)loc_part0 * 60;
                }
                else if (loc_command == "ONCAPTURE")
                {
                    e_no_sensor = llDumpList2String(loc_parts, "|");
                }
                else if (loc_command == "ONRELEASE")
                {
                    gc = llDumpList2String(loc_parts, "|");
                }
                e_state_entry = llGetNotecardLine("AVpos", ++gY);
            }
        }
    }
    on_rez(integer g)
    {
        c();
    }
}
